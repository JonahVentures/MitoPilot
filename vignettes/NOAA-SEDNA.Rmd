---
title: "NOAA SEDNA"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{NOAA SEDNA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# How to use MitoPilot on the NOAA NMFS SENDA computing cluster

You will need an account to access the SEDNA computing cluster. Detailed instructions can be found [here](https://docs.google.com/document/d/1nn0T0OWEsQCBoCdaH6DSY69lQSbK3XnPlseyyQuU2Lc/edit?usp=sharing). Or contact Krista Nichols (<krista.nichols@noaa.gov>) for more information. 

## First time setup

For first time setup, you will need to create a Mamba environment for two MitoPilot dependencies, Nextflow and Singularity. Login to the NOAA NMFS VPN, login to SEDNA, then run the following.

```{bash eval=F}
mamba create --name MitoPilot_deps bioconda::nextflow conda-forge::singularity -y
mamba activate MitoPilot_deps
```
 
You can now call `nextflow` and `singularity` from anywhere on the cluster, as long as this `mamba` environment is activated.

The following commands will set up RStudio server. First launch an interactive session.

```{bash eval=F}
# Start an interactive session
srun -c 2 --mem=4GB -p standard --pty /bin/bash
```

Then run the following. You can choose a different version of RStudio, if desired. It may take a few minutes to download and set up the Singularity image file.

```{bash eval=F}
# Make a directory to host R-studio. 
mkdir -p ~/rstudio
cd ~/rstudio

# Pull R studio from singularity. Note, you can change the version
mamba activate singularity-3.8.6
singularity pull docker://rocker/rstudio:4.4.1

mkdir -p run var-lib-rstudio-server
printf 'provider=sqlite\ndirectory=/var/lib/rstudio-server\n' > database.conf
```

Now let's make a helper script to launch RStudio server.

```{bash eval=F}
# set up bin directory if it doesn't exist
mkdir ~/bin 

# create helper script
# IMPORTANT: "Rstudio_version" must match the version you downloaded in the previous step
cat > ~/bin/start-rstudio-server-MitoPilot <<'EOL'
#!/bin/bash
# script to start Rstudio server 
# and print instructions on how to connect

# change this if you downloaded a different RStudio Server version 
Rstudio_version="4.4.1"

cd ~/rstudio
source ~/.bashrc

# Assign yourself a port
PORT=$(shuf -i 8000-9000 -n 1)

HOST=$( hostname )

GREEN='\033[0;32m' # green ANSI
RED='\033[0;31m' # red ANSI
NC='\033[0m' # no color ANSI

echo ""
echo -e "${GREEN}TO ACCESS RSTUDIO SERVER${NC}"
echo "In a terminal on your local system, run the following command:"
echo "ssh -N -L 8787:${HOST}:${PORT} ${USER}@sedna.nwfsc2.noaa.gov"
echo ""
echo "Enter your password when prompted"
echo "If successful, nothing will happen"
echo "Then open http://localhost:8787 on a local web browser"
echo "" 
echo -e "${RED}NOTE:${NC} This window and your local terminal session"
echo "must remain open in order to access the Rstudio server"
echo ""

mamba activate MitoPilot_deps

# set Singularity temp dir, if needed
# if not set, Singularity will write to /tmp on the compute nodes
#mkdir -p "${HOME}/.singularity/temp"
#export SINGULARITY_TMPDIR="${HOME}/.singularity/temp"

singularity exec \
 --bind run:/run,var-lib-rstudio-server:/var/lib/rstudio-server,database.conf:/etc/rstudio/database.conf \
 rstudio_${Rstudio_version}.sif \
 rserver --www-address=0.0.0.0 --www-port=${PORT} --server-user=${USER}
EOL

# make script executable
chmod 755 ~/bin/start-rstudio-server-MitoPilot
```

## Launching RStudio server

To launch RStudio server, simply run `start-rstudio-server-MitoPilot` anywhere within SENDA. Follow the instructions to access your RStudio server session. They should look something like this.

```
TO ACCESS RSTUDIO SERVER
In a terminal on your local system, run the following command:
ssh -N -L 8787:node01.cluster:8377 dmacguigan@sedna.nwfsc2.noaa.gov

Enter your password when prompted
If successful, nothing will happen
Then open http://localhost:8787 on a local web browser

NOTE: This window and your local terminal session
must remain open in order to access the Rstudio server
```

## Installing and launching MitoPilot

Now we can install MitoPilot! Within RStudio server, run the following.

```{R eval=F}
if (!requireNamespace("BiocManager", quietly = TRUE)) {
  install.packages("BiocManager")
}
BiocManager::install("JonahVentures/MitoPilot")
```

If installation was successful, run `library(MitoPilot)` to load the package.

If you need to update MitoPilot, simply run the BiocManager installation command again. If you would like to ensure that youâ€™re using the latest MitoPilot version, run `remove.packages("MitoPilot")` prior to installation.

Want to learn how to use MitoPilot? Check out the [Test Project Tutorial](https://jonahventures.github.io/MitoPilot/articles/test-project.html).


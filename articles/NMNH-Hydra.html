<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>NMNH Hydra Setup • MitoPilot</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="NMNH Hydra Setup">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MitoPilot</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/MitoPilot.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/FAQ.html">Frequently Asked Questions</a></li>
    <li><a class="dropdown-item" href="../articles/NMNH-Hydra.html">NMNH Hydra Setup</a></li>
    <li><a class="dropdown-item" href="../articles/NOAA-SEDNA.html">NOAA SEDNA Setup</a></li>
    <li><a class="dropdown-item" href="../articles/Fish-Mitogenome-Curation.html">Fish Mitogenome Curation</a></li>
    <li><a class="dropdown-item" href="../articles/custom_dbs.html">Building Custom Databases</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Smithsonian/MitoPilot/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>NMNH Hydra Setup</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Smithsonian/MitoPilot/blob/main/vignettes/NMNH-Hydra.Rmd" class="external-link"><code>vignettes/NMNH-Hydra.Rmd</code></a></small>
      <div class="d-none name"><code>NMNH-Hydra.Rmd</code></div>
    </div>

    
    
<style>
.alert {
  border-left: 5px solid;
  padding: 10px;
  margin: 10px 0;
  border-radius: 5px;
}
.alert-tip { border-color: #28A745; background-color: #E9F7EF; }
.alert-note { border-color: #007BFF; background-color: #EBF5FF; }
.alert-warning { border-color: #FFC107; background-color: #FFF9E6; }
.alert-danger { border-color: #DC3545; background-color: #F8D7DA; }
strong { font-weight: bold; }
</style>
<div class="section level2">
<h2 id="how-to-use-mitopilot-on-the-smithsonian-hydra-computing-cluster">How to use MitoPilot on the Smithsonian Hydra computing cluster<a class="anchor" aria-label="anchor" href="#how-to-use-mitopilot-on-the-smithsonian-hydra-computing-cluster"></a>
</h2>
<p>You will need an account to access the Hyrda computing cluster.
Instructions are available <a href="https://confluence.si.edu/display/HPC/Hydra+Policies" class="external-link">here</a>.</p>
<div class="section level3">
<h3 id="first-time-setup">First time setup<a class="anchor" aria-label="anchor" href="#first-time-setup"></a>
</h3>
<p>Dan MacGuigan has submitted a request to the Hydra team for
installation of a Nextflow module. But for now, you will need to install
your own copy of Nextflow on the cluster. Login to Hydra and run the
following.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Nextflow installation instructions</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co"># from https://www.nextflow.io/docs/latest/install.html</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="bu">cd</span> ~</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="ex">module</span> load tools/java/21.0.2</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-s</span> https://get.nextflow.io <span class="kw">|</span> <span class="fu">bash</span> <span class="co"># install Nextflow</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">chmod</span> +x nextflow <span class="co"># make Nextflow executable</span></span></code></pre></div>
<p>There will now be an executable <code>nextflow</code> file in your
home directory. You should move it to a location that is in your
<code>PATH</code>. For example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">mkdir</span> ~/bin <span class="co"># create bin directory, if needed</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">mv</span> ~/nextflow ~/bin/nextflow <span class="co"># move nextflow to bin directory</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="bu">echo</span> <span class="st">'export PATH="${HOME}/bin:${PATH}"'</span> <span class="op">&gt;&gt;</span> ~/.bashrc <span class="co"># add bin directory to PATH, in case it's not already there</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span></code></pre></div>
<p>This should allow you to call <code>nextflow</code> from anywhere on
the cluster.</p>
<div class="alert alert-note">
<p><strong>Note:</strong> You must load the Hydra Java module
(<code>module load tools/java/21.0.2</code>) whenever you wish to use
Nextflow.</p>
</div>
</div>
<div class="section level3">
<h3 id="launching-rstudio-server">Launching RStudio server<a class="anchor" aria-label="anchor" href="#launching-rstudio-server"></a>
</h3>
<p>We will use RStudio server to run MitoPilot. RStudio server functions
much like the RStudio on your local computer, but using the Hydra
cluster’s data storage and computational resources.</p>
<p>There are two ways to access RStudio server on Hydra.</p>
<div class="section level4">
<h4 id="tunneling-to-a-rstudio-server-session">Tunneling to a RStudio server session<a class="anchor" aria-label="anchor" href="#tunneling-to-a-rstudio-server-session"></a>
</h4>
<p>We recommend always using an interactive session when tunneling to
RStudio server. This avoids unnecessary computational burden on the
login nodes. To launch an interactive session, run the following.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">qrsh</span> <span class="at">-l</span> h_rt=24:00:00 <span class="at">-pe</span> mthread 2</span></code></pre></div>
<div class="alert alert-note">
<p><strong>Note:</strong> You must include <code>-pe mthread 2</code> in
order to have enough available RAM for building the MitoPilot
Singularity image.</p>
</div>
<div class="alert alert-note">
<p><strong>Note:</strong> Interactive sessions on Hydra can run for a
maximum of 24 hours. Additionally, users are limited to one active
interactive session at a time.</p>
</div>
<p>Once your interactive session has started, launch RStudio server.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># avoid package conflicts (may not be necessary for all users)</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="ex">conda</span> deactivate </span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"># load the RStudio server module</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="ex">module</span> load tools/R/RStudio/server</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co"># launch RStudio server</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="ex">start-rstudio-server</span></span></code></pre></div>
<div class="alert alert-note">
<p><strong>Note:</strong> If this is your first time launching RStudio
server, you may be asked to run a different command.</p>
</div>
<p>You will see something like this printed to your screen.</p>
<pre><code>start-rstudio-server: starting RStudio server on host=login02 and port=8787
  you need to create a ssh tunnel on your local machine with
    ssh -N -L 8787:login02:8787 macguigand@hydra-login01.si.edu

Point your browser to http://localhost:8787 on your local machine.
Use Control+C in this window to kill the server when done.

TTY detected. Printing informational message about logging configuration. Logging configuration loaded from '/etc/rstudio/logging.conf'. Logging to '/home/macguigand/.local/share/rstudio/log/rserver.log'.</code></pre>
<div class="alert alert-note">
<p><strong>Note:</strong> If you get a message saying “ERROR system
error 98 (Address already in use)”, someone else has a tunnel
established with the default port (8787). To fix this, try using a
different port, e.g. <code>start-rstudio-server -port 8890</code>. Any
port number between 1025-65535 is allowed.</p>
</div>
<p>Leave this cluster terminal window open, open a new terminal window
on your local computer, and run the <code>ssh</code> command printed by
<code>start-rstudio-server</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-N</span> <span class="at">-L</span> 8787:login02:8787 macguigand@hydra-login01.si.edu</span></code></pre></div>
<p>Enter your Hydra password when prompted. If nothing happens, this
means that you have successfully established a SSH tunnel and can
connect to RStudio server.</p>
<p>Leaving both terminal windows open, enter <a href="http://localhost:YOUR_PORT_NUMBER" class="external-link">http://localhost:YOUR_PORT_NUMBER</a>
in a web browser. We recommend using Chrome or Firefox. There are some
known issues running MitoPilot with Safari.</p>
<p>Enter your cluster login credentials to access the RStudio server.
This should open a full RStudio session in your browser. Any R commands
run in this RStudio window will execute on the cluster.</p>
</div>
<div class="section level4">
<h4 id="rstudio-galaxy-server">RStudio Galaxy server<a class="anchor" aria-label="anchor" href="#rstudio-galaxy-server"></a>
</h4>
<p>The Hydra Team recently launched a new interactive R Studio
environment that is accessible directly via a browser, at <a href="https://galaxy.si.edu/R4" class="external-link">https://galaxy.si.edu/R4</a>.</p>
<p>Hydra users can leverage this server to test, debug, and develop R
based workflows using the interactive R Studio GUI (currently running R
4.4.3).</p>
<p>By logging in with your Hydra account credentials, users will have
access to the storage under /pool, /scratch and /store. This server
offers resources totaling 192 CPUs and 1.5 T of RAM.</p>
<p><strong><em>Notes:</em></strong></p>
<ol style="list-style-type: decimal">
<li>This is a shared resource and should be used accordingly. Long
running jobs or jobs requiring the entire resources of the server would
be more appropriate as a job submission.</li>
<li>This server is only accessible from trusted computers, not on the
public internet. However, if you can access Hydra, you should be able to
access this server. For technical reasons, to access this resource via
telework.si.edu, go to <a href="https://galaxy.si.edu" class="external-link">https://galaxy.si.edu</a> and then choose
the “R4 v443” option.</li>
<li>This is a new resource - please be patient as we test this offering
with our user community. We will evaluate this test once Hydra is moved
to the new data center and decide whether it should be kept or altered
in any way.</li>
</ol>
</div>
</div>
<div class="section level3">
<h3 id="installing-mitopilot">Installing MitoPilot<a class="anchor" aria-label="anchor" href="#installing-mitopilot"></a>
</h3>
<p>To install MitoPilot, use the RStudio server window to run the
following. This might take a while.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu">install</span><span class="op">(</span><span class="st">"Smithsonian/MitoPilot"</span><span class="op">)</span></span></code></pre></div>
<p>If the installation was successful, you’re ready to start using
MitoPilot!</p>
</div>
<div class="section level3">
<h3 id="updating-mitopilot">Updating MitoPilot<a class="anchor" aria-label="anchor" href="#updating-mitopilot"></a>
</h3>
<p>If you need to update MitoPilot, simply run the BiocManager
installation command again. If you would like to ensure that you’re
using the latest MitoPilot version, run
<code>remove.packages("MitoPilot")</code> prior to installation.</p>
<p>After updating MitoPilot, we recommend restarting R (in RStudio,
Session &gt; Restart R or run <code>.rs.restartR()</code>) and then
reloading the package with <code><a href="https://github.com/Smithsonian/MitoPilot" class="external-link">library(MitoPilot)</a></code>.</p>
<p>We also recommend clearing your Singularity cache with
<code>singularity cache clean</code> to ensure you are using the latest
MitoPilot Singularity image.</p>
</div>
<div class="section level3">
<h3 id="launching-mitopilot">Launching MitoPilot<a class="anchor" aria-label="anchor" href="#launching-mitopilot"></a>
</h3>
<p>To load the MitoPilot R package, run <code><a href="https://github.com/Smithsonian/MitoPilot" class="external-link">library(MitoPilot)</a></code>
within your RStudio server session. You can now utilize all of
MitoPilot’s functions, such as <a href="https://smithsonian.github.io/MitoPilot/#initializing-a-project">initializing
a project</a> or <a href="https://smithsonian.github.io/MitoPilot/#running-the-pipeline">opening
the R Shiny GUI</a>.</p>
<p>Want to learn how to use MitoPilot? Check out the <a href="https://Smithsonian.github.io/MitoPilot/articles/test-project.html" class="external-link">Test
Project Tutorial</a>.</p>
</div>
<div class="section level3">
<h3 id="running-large-mitopilot-jobs">Running Large MitoPilot Jobs<a class="anchor" aria-label="anchor" href="#running-large-mitopilot-jobs"></a>
</h3>
<p>If you have a large number of samples to process (more than a few
dozen), we recommend running the assemble and annotate MitoPilot modules
as batch jobs.</p>
<p>Running these modules within the R Shiny GUI requires you to maintain
an open connection to the cluster. There may be issues restarting if the
connection breaks while Nextflow is running. Instead, we can “fire and
forget” by submitting batch jobs.</p>
<p>First, initialize your new project and modify any desired parameters
using the GUI. Once ready, click <code>UPDATE</code>. A new window
should appear.</p>
<p><img src="figures/test-project/8.png"></p>
<p>Rather than clicking the <code>Start Nextflow</code> button, copy the
Nextflow command and create a submission script. We have provided a
template below. You may wish to modify the job name (<code>-N</code>)
and the log file name (<code>-o</code>).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">#$ -N MitoPilot_assembly # MODIFY THIS IF DESIRED</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">#$ -o MitoPilot_assembly.log # MODIFY THIS IF DESIRED</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">#$ -cwd -j y</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="co">#$ -q lTWFM.sq</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co">#$ -l wfmq</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co">#$ -pe mthread 2</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co">#$ -S /bin/sh</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="bu">echo</span> + <span class="kw">`</span><span class="fu">date</span><span class="kw">`</span> job <span class="va">$JOB_NAME</span> started in <span class="va">$QUEUE</span> with jobID=<span class="va">$JOB_ID</span> on <span class="va">$HOSTNAME</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="ex">module</span> load tools/java/21.0.2 <span class="co"># required for Nextflow on Hydra</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="co"># NEXTFLOW COMMAND, example below</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="ex">nextflow</span> <span class="at">-log</span> /pool/public/genomics/macguigand/MitoPilot/22030FL-06-02/run_02/.logs/nextflow.log run /home/macguigand/R/x86_64-pc-linux-gnu-library/4.4/MitoPilot/nextflow <span class="at">-c</span> /pool/public/genomics/macguigand/MitoPilot/22030FL-06-02/run_02/.config <span class="at">-entry</span> WF1</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a><span class="bu">echo</span> = <span class="kw">`</span><span class="fu">date</span><span class="kw">`</span> job <span class="va">$JOB_NAME</span> done</span></code></pre></div>
<div class="alert alert-note">
<p><strong>Note:</strong> You must use the options
<code>-q lTWFM.sq</code> and <code>-l wfmq</code>. This is a special
Hydra queue for workflow managers like Nextflow. You must also include
<code>-pe mthread 2</code> in order to have enough available RAM for
building the MitoPilot Singularity image.</p>
</div>
<p>Move the submission script into your MitoPilot run directory (in the
above example,
<code>/pool/public/genomics/macguigand/MitoPilot/22030FL-06-02/run_02/</code>).
Then submit the job using <code>qsub MY_SCRIPT_NAME.sh</code>.</p>
<p>You can monitor the progress of this job using the <code>qstat</code>
command and by checking on the log files. Once the job is done, you can
relaunch the GUI to inspect the results. The same approach can be used
for the annotate module.</p>
</div>
<div class="section level3">
<h3 id="known-issues">Known Issues<a class="anchor" aria-label="anchor" href="#known-issues"></a>
</h3>
<p>If when launching RStudio server you receive the error message
<code>[rserver] ERROR system error 98 (Address already in use);</code>,
the TCP port is already in use by another user. Specify a different port
in the range of 1025-65535 when starting the server. E.g.,
<code>start-studio-server -port 8890</code>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Devin Leopold, Dan MacGuigan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
